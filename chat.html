<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chat - PetWise</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{font-family:sans-serif;background:#ece5dd;margin:0;}
#chat{height:70vh;overflow-y:auto;padding:10px;border:1px solid #ccc;background:#fff;margin-bottom:10px;}
.msg.mine{background:#c6f2f8;text-align:right;padding:5px;border-radius:5px;margin:5px;}
.msg.other{background:#fff;text-align:left;padding:5px;border-radius:5px;margin:5px;}
</style>
</head>
<body class="p-3">

<div id="chat"></div>
<textarea id="mensaje" rows="2" class="form-control" placeholder="Escribe tu mensaje..."></textarea>
<button id="enviar" class="btn btn-primary mt-2">Enviar</button>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const supabaseUrl = "https://uhmnpclrrpxmzbfnroji.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVobW5wY2xycnB4bXpiZm5yb2ppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5MzM1NzgsImV4cCI6MjA3MjUwOTU3OH0.kjw1bFjucsVw43HnmNtMZ50MdqrYOypNo-Tgb_DpDgc";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

const chatDiv = document.getElementById("chat");
const mensajeInput = document.getElementById("mensaje");
const enviarBtn = document.getElementById("enviar");

// Usuario actual
let user = null;
async function init() {
    const { data } = await supabase.auth.getUser();
    user = data.user;
    if(!user) window.location.href = "index.html";
}
init();

// Usuario destino
const params = new URLSearchParams(window.location.search);
const toId = params.get("to");

// Mostrar mensajes
async function cargarMensajes(){
    const { data } = await supabase.from("mensajes")
        .select("*")
        .or(`and(from_user.eq.${user.id},to_user.eq.${toId}),and(from_user.eq.${toId},to_user.eq.${user.id})`)
        .order("created_at",{ascending:true});
    chatDiv.innerHTML = "";
    if(data) data.forEach(m => {
        const div = document.createElement("div");
        div.className = m.from_user===user.id?"msg mine":"msg other";
        div.textContent = m.contenido;
        chatDiv.appendChild(div);
    });
    chatDiv.scrollTop = chatDiv.scrollHeight;
}
cargarMensajes();

// Enviar mensaje
enviarBtn.addEventListener("click", async () => {
    const contenido = mensajeInput.value.trim();
    if(!contenido) return;
    await supabase.from("mensajes").insert([{ from_user: user.id, to_user: toId, contenido }]);
    mensajeInput.value = "";
    cargarMensajes();
});
</script>
</body>
</html>
